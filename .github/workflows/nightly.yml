name: Nightly

on:
    push:
        branches: [ main ]

permissions:
    contents: write

concurrency:
    group: nightly
    cancel-in-progress: true

jobs:
    build:
        name: Build ${{ matrix.name }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: linux-amd64
                      runner: ubuntu-22.04
                      goos: linux
                      goarch: amd64
                    - name: linux-arm64
                      runner: ubuntu-22.04-arm64
                      goos: linux
                      goarch: arm64
                    - name: windows-amd64
                      runner: windows-latest
                      goos: windows
                      goarch: amd64
                    - name: macos-arm64
                      runner: macos-14
                      goos: darwin
                      goarch: arm64

        runs-on: ${{ matrix.runner }}

        steps:
            - uses: actions/checkout@v4

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version-file: go.mod
                  cache: true

            - name: Setup Node
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: 'frontend/package-lock.json'

            - name: Upgrade npm (work around optional deps bugs)
              run: npm i -g npm@latest

            - name: Clean install (frontend)
              run: npm ci --prefix frontend

            - name: Rollup platform fix
              working-directory: frontend
              shell: bash
              run: |
                  set -e
                  os="$(uname -s)"; arch="$(uname -m)"
                  case "$os-$arch" in
                    Linux-x86_64)  pkg='@rollup/rollup-linux-x64-gnu' ;;
                    Linux-aarch64) pkg='@rollup/rollup-linux-arm64-gnu' ;;
                    Darwin-arm64)  pkg='@rollup/rollup-darwin-arm64' ;;
                    Darwin-x86_64) pkg='@rollup/rollup-darwin-x64' ;;
                    MINGW*|MSYS*|CYGWIN*|Windows_NT-*) pkg='@rollup/rollup-win32-x64-msvc' ;;
                    *) pkg='' ;;
                  esac
                  [ -n "$pkg" ] && npm i --no-save -D "$pkg"

            - name: "Linux: install Wails build deps"
              if: ${{ startsWith(matrix.runner, 'ubuntu-') }}
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    libgtk-3-dev \
                    libwebkit2gtk-4.0-dev \
                    libayatana-appindicator3-dev \
                    librsvg2-dev

            - name: Setup Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

            - name: Install Task
              run: go install github.com/go-task/task/v3/cmd/task@latest

            - name: Ensure frontend/dist exists
              run: task ensure-dist

            - name: Clean old binaries
              shell: bash
              run: rm -rf build/bin || true

            - name: Wails build (current OS/arch)
              shell: bash
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
              run: wails build -clean

            - name: Package
              shell: bash
              run: |
                  mkdir -p out
                  ARCHIVE="opensplit-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
                  case "${{ matrix.goos }}" in
                    windows)
                      pwsh -NoProfile -Command "Compress-Archive -Path 'build/bin/*' -DestinationPath \"out/$ARCHIVE\" -Force"
                      ;;
                    darwin)
                      ditto -c -k --sequesterRsrc --keepParent build/bin "out/$ARCHIVE"
                      ;;
                    *)
                      # NOTE: go two levels up to write into repo-root/out
                      (cd build/bin && zip -r "../../out/$ARCHIVE" .)
                      ;;
                  esac
                  echo "ARCHIVE=out/$ARCHIVE" >> "$GITHUB_ENV"

            - name: Upload artifact (per platform)
              uses: actions/upload-artifact@v4
              with:
                  name: nightly-zips-${{ matrix.name }}
                  path: ${{ env.ARCHIVE }}

    publish:
        name: Publish Nightly Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  pattern: nightly-zips-*
                  merge-multiple: true
                  path: dist

            - name: Ensure 'nightly' release exists
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release view nightly >/dev/null 2>&1 || \
                    gh release create nightly --title "Nightly" --prerelease --notes "Rolling nightly build" --latest=false

            - name: Upload assets (clobber)
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  shopt -s nullglob
                  for f in dist/*; do
                    echo "Uploading $f"
                    gh release upload nightly "$f" --clobber
                  done
