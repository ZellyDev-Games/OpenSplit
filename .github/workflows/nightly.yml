name: Nightly

on:
    push:
        branches: [ main ]

permissions:
    contents: write

concurrency:
    group: nightly
    cancel-in-progress: true

jobs:
    build:
        name: Build ${{ matrix.name }}
        strategy:
            fail-fast: false
            matrix:
                include:
                    - name: linux-amd64
                      runner: ubuntu-24.04
                      goos: linux
                      goarch: amd64
                    - name: linux-arm64
                      runner: ubuntu-24.04-arm
                      goos: linux
                      goarch: arm64
                    - name: windows-amd64
                      runner: windows-latest
                      goos: windows
                      goarch: amd64
                    - name: macos-arm64
                      runner: macos-14
                      goos: darwin
                      goarch: arm64

        runs-on: ${{ matrix.runner }}

        steps:
            - uses: actions/checkout@v5

            - name: Setup Go
              uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true

            - uses: actions/setup-node@v5
              with:
                  node-version: 20

            - name: Upgrade npm
              run: npm i -g npm@latest

            - name: Create lockfile for cache
              run: npm install --prefix frontend --package-lock-only --no-audit --no-fund

            - uses: actions/setup-node@v5
              with:
                  node-version: 20
                  cache: npm
                  cache-dependency-path: frontend/package-lock.json

            # Use npm install (not ci) so platform optionalDependencies resolve per runner OS/arch
            - name: Install frontend deps
              run: npm install --prefix frontend

            # Ensure the *exact* rollup-native version is present (matches rollup's version)
            - name: Ensure Rollup native binary (exact version)
              working-directory: frontend
              shell: bash
              run: |
                  set -euo pipefail
                  os="$(uname -s)"; arch="$(uname -m)"
                  case "$os-$arch" in
                    Linux-x86_64)  pkg='@rollup/rollup-linux-x64-gnu' ;;
                    Linux-aarch64) pkg='@rollup/rollup-linux-arm64-gnu' ;;
                    Darwin-arm64)  pkg='@rollup/rollup-darwin-arm64' ;;
                    Darwin-x86_64) pkg='@rollup/rollup-darwin-x64' ;;
                    MINGW*|MSYS*|CYGWIN*|Windows_NT-*) pkg='@rollup/rollup-win32-x64-msvc' ;;
                    *) pkg='' ;;
                  esac
                  if [ -n "$pkg" ]; then
                    ver="$(node -p "require('rollup/package.json').version")"
                    echo "Installing $pkg@$ver"
                    npm i --no-save -D "$pkg@$ver"
                    node -e "require('$pkg'); console.log('OK: $pkg present')"
                  fi

            # Build the frontend now, so we can skip Wails' install/build
            - name: Build frontend
              run: npm run build --prefix frontend

            - name: "Linux: install Wails build deps"
              if: ${{ startsWith(matrix.runner, 'ubuntu-') }}
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential libgtk-3-dev libwebkit2gtk-4.1-dev

            - name: Setup Wails
              run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

            - name: Install Task
              run: go install github.com/go-task/task/v3/cmd/task@latest

            - name: Ensure frontend/dist exists
              run: task ensure-dist

            - name: Clean old binaries
              shell: bash
              run: rm -rf build/bin || true

            # IMPORTANT: -s skips Wails' frontend install/build steps
            - name: Wails build (current OS/arch, skip frontend steps)
              shell: bash
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
              run: wails build -tags webkit2_41 -clean -s

            - name: Package
              shell: bash
              run: |
                  mkdir -p out
                  ARCHIVE="opensplit-${{ matrix.goos }}-${{ matrix.goarch }}.zip"
                  case "${{ matrix.goos }}" in
                    windows)
                      pwsh -NoProfile -Command "Compress-Archive -Path 'build/bin/*' -DestinationPath \"out/$ARCHIVE\" -Force"
                      ;;
                    darwin)
                      ditto -c -k --sequesterRsrc --keepParent build/bin "out/$ARCHIVE"
                      ;;
                    *)
                      (cd build/bin && zip -r "../../out/$ARCHIVE" .)
                      ;;
                  esac
                  echo "ARCHIVE=out/$ARCHIVE" >> "$GITHUB_ENV"

            - name: Upload artifact (per platform)
              uses: actions/upload-artifact@v4
              with:
                  name: nightly-zips-${{ matrix.name }}
                  path: ${{ env.ARCHIVE }}

            # (Optional) Debug if rollup fails again
            - name: Debug rollup layout
              if: failure()
              working-directory: frontend
              run: |
                  node -p "require('rollup/package.json').version" || true
                  ls -la node_modules/@rollup || true
                  grep -A2 optionalDependencies node_modules/rollup/package.json || true

    publish:
        name: Publish Nightly Release
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Download all artifacts
              uses: actions/download-artifact@v5
              with:
                  pattern: nightly-zips-*
                  merge-multiple: true
                  path: dist

            - name: Ensure 'nightly' release exists
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  gh release view nightly --repo "${{ github.repository }}" >/dev/null 2>&1 || \
                    gh release create nightly --repo "${{ github.repository }}" --title "Nightly" --prerelease --notes "Rolling nightly build" --latest=false

            - name: Upload assets (overwrite if exist)
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  shopt -s nullglob
                  for f in dist/*; do
                    echo "Uploading $f"
                    gh release upload nightly "$f" --clobber --repo "${{ github.repository }}"
                  done
